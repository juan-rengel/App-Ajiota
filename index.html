<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Empr√©stimos</title>

<!-- Bibliotecas para exporta√ß√£o -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
  --bg: #0a0f1f;
  --card: #141c2f;
  --text: #e2e8f0;
  --muted: #94a3b8;
  --accent: #27cbe0;
  --success: #17db9a;
  --danger: #ef4444;
  --border: rgba(255, 255, 255, 0.432);
  --radius: 12px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Inter", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 16px;
}
.container{
  max-width: 800px;
  margin: auto;
}
h1 {
  text-align: center;
  font-size: 2rem;
  margin-bottom: 12px;
}
.top-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}
.summary-card {
  flex: 1 1 160px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 12px;
  text-align: center;
}
.summary-card .label { color: var(--muted); font-size: 0.8rem; }
.summary-card .value { font-size: 1.1rem; font-weight: bold; margin-top: 4px; color: var(--accent); }

.export-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  text-align: center;
  flex: 1 1 160px;
}
.export-card button {
  width: 100%;
  margin-top: 8px;
  padding: 8px;
  border: none;
  border-radius: var(--radius);
  font-weight: bold;
  cursor: pointer;
}
button.excel { background: #22c55e; color: white; }
button.pdf { background: #ef4444; color: white; }

.form-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 18px;
}
form {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
form input {
  flex: 1 1 180px;
  padding: 8px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text);
}
button.add {
  padding: 10px 14px;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  font-weight: bold;
  background: var(--accent);
  color: white;
}
button.delete {
  background: var(--danger);
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 6px 10px;
}
button.edit {
  background: var(--success);
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 6px 10px;
}
.search-box {
  margin-bottom: 14px;
  display: flex;
  justify-content: center;
}
.search-box input {
  width: 100%;
  max-width: 500px;
  padding: 10px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text);
  text-align: center;
}
.loan-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.loan-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
}
.loan-row {
  display: flex;
  justify-content: space-between;
  margin: 4px 0;
  font-size: 0.9rem;
}
.loan-row strong { color: var(--muted); }
.actions {
  display: flex;
  justify-content: end;
  gap: 6px;
  margin-top: 8px;
}
.status {
  padding: 4px 8px;
  border-radius: 8px;
  font-weight: 600;
}
.status.ok { background: rgba(16,185,129,0.1); color: var(--success); }
.status.late { background: rgba(239,68,68,0.1); color: var(--danger); }
.days-left {
  font-weight: bold;
  margin-top: 6px;
}
.days-left.ok { color: var(--success); }
.days-left.warn { color: #facc15; }
.days-left.late { color: var(--danger); }

button.adjust {
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 6px 10px;
}

@media (max-width: 600px) {
  .loan-row { flex-direction: column; align-items: flex-start; }
}

.navbar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #0f172a;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  z-index: 1000;
}
.nav-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  max-width: 1200px;
  margin: 0 auto;
}
.nav-logo {
  font-size: 1.3rem;
  color: #3b82f6;
  font-weight: bold;
}
.nav-links {
  list-style: none;
  display: flex;
  gap: 20px;
  margin: 0;
  padding: 0;
}
.nav-links a {
  display: block;
  text-decoration: none;
  color: #e2e8f0;
  font-weight: 500;
  transition: color 0.3s;
}
.nav-links a:hover {
  color: #3b82f6;
}
.nav-toggle {
  display: none;
  background: none;
  border: none;
  color: #e2e8f0;
  font-size: 1.5rem;
  cursor: pointer;
}
@media (max-width: 768px) {
  .nav-toggle { display: block; }
  .nav-links {
    display: none;
    flex-direction: column;
    position: absolute;
    top: 60px;
    left: 0;
    width: 100%;
    background: #1e293b;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  .nav-links.show { display: flex; }
  .nav-links li {
    text-align: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
}
body {
  padding-top: 70px; /* evita sobreposi√ß√£o do menu fixo */
}

/* Modal b√°sico */
.modal {
  display: none;
  position: fixed; 
  z-index: 2000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.6);
  align-items: center;
  justify-content: center;
}
.modal-content {
  background: var(--card);
  padding: 20px;
  border-radius: var(--radius);
  max-width: 400px;
  margin: auto;
  color: var(--text);
  text-align: center;
}
.modal-content h2 {
  margin-bottom: 12px;
}
#adjustInput {
  width: 80%;
  padding: 8px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  margin-bottom: 10px;
  background: transparent;
  color: var(--text);
}
.modal-buttons {
  display: flex;
  justify-content: space-around;
}
.btn {
  padding: 8px 16px;
  border-radius: var(--radius);
  border: none;
  font-weight: bold;
  cursor: pointer;
}
.btn.cancel {
  background: var(--danger);
  color: white;
}
.btn.confirm {
  background: var(--success);
  color: white;
}
.error-msg {
  color: var(--danger);
  margin-top: 8px;
  min-height: 20px;
}
</style>
</head>
<body>
<div class="container">
  <!-- üîπ MENU FIXO DARK RESPONSIVO -->
<nav class="navbar">
  <div class="nav-container">
    <div class="nav-logo">üí∏ Finance IA</div>
    <button class="nav-toggle" id="navToggle">‚ò∞</button>
    <ul class="nav-links" id="navLinks">
      <li><a href="index.html">üè† Home</a></li>
      <li><a href="dashboard.html">üìä Dashboard</a></li>
    </ul>
  </div>
</nav>

<h1>üìò Controle de Empr√©stimos</h1>

<div class="top-summary">
  <div class="summary-card">
    <div class="label">Total Emprestado</div>
    <div class="value" id="sumPrincipal">R$ 0,00</div>
  </div>
  <div class="summary-card">
    <div class="label">Total com Juros</div>
    <div class="value" id="sumWithInterest">R$ 0,00</div>
  </div>
  <div class="summary-card">
    <div class="label">Total Pendente</div>
    <div class="value" id="sumPending">R$ 0,00</div>
  </div>
  <div class="summary-card">
    <div class="label">Pendentes</div>
    <div class="value" id="countPending">0</div>
  </div>

  <div class="export-card">
    <div class="label">Exportar Dados</div>
    <button class="excel" onclick="exportExcel()">üìó Excel</button>
    <button class="pdf" onclick="exportPDF()">üìï PDF</button>
  </div>
</div>

<div class="form-card">
  <form id="loanForm">
    <input type="hidden" id="editIndex" />
    <input type="text" id="personName" placeholder="Nome da pessoa" required />
    <input type="number" id="loanAmount" placeholder="Valor (R$)" step="0.01" required />
    <input type="number" id="daysToPay" placeholder="Dias para pagar" required />
    <input type="number" id="interestRate" placeholder="Juros di√°rio (%)" step="0.01" required />
    <input type="date" id="loanDate" required />
    <button class="add" type="submit" id="submitBtn">Adicionar</button>
  </form>
</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="üîç Buscar por nome..." />
</div>

<div class="loan-list" id="loanList"></div>
</div>

<!-- Modal Ajuste de Valor -->
<div id="adjustModal" class="modal">
  <div class="modal-content">
    <h2>Ajustar Valor do Empr√©stimo</h2>
    <p id="adjustPerson"></p>
    <input type="number" id="adjustInput" step="0.01" placeholder="Digite o valor do ajuste (+ ou -)" />
    <div class="modal-buttons">
      <button id="cancelAdjust" class="btn cancel">Cancelar</button>
      <button id="confirmAdjust" class="btn confirm">Confirmar</button>
    </div>
    <p id="adjustError" class="error-msg"></p>
  </div>
</div>

<script>
document.getElementById('navToggle').addEventListener('click', () => {
  document.getElementById('navLinks').classList.toggle('show');
});

const $ = (s) => document.querySelector(s);
function money(v) {
  return 'R$ ' + Number(v).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}
function parseNum(v) {
  return parseFloat(v) || 0;
}
function loadLoans() {
  return JSON.parse(localStorage.getItem('loansData') || '[]');
}
function saveLoans(d) {
  localStorage.setItem('loansData', JSON.stringify(d));
}

function renderLoans(filter = '') {
  const list = $('#loanList');
  const data = loadLoans().filter((l) => l.personName.toLowerCase().includes(filter.toLowerCase()));
  list.innerHTML = '';
  let sumPrincipal = 0,
    sumWithInterest = 0,
    sumPending = 0,
    countPending = 0;
  const now = new Date();
  data.forEach((loan, i) => {
    const principal = parseNum(loan.loanAmount);
    const days = Number(loan.daysToPay);
    const rate = parseNum(loan.interestRate);
    const juros = principal * (rate / 100) * days;
    const totalPrev = principal + juros;
    const due = new Date(loan.loanDate);
    due.setDate(due.getDate() + days);
    const diff = Math.floor((due - now) / (1000 * 60 * 60 * 24));
    const atrasado = diff < 0;
    const multa = atrasado ? totalPrev * 0.02 * -diff : 0;
    const totalComMulta = totalPrev + multa;
    sumPrincipal += principal;
    sumWithInterest += totalPrev;
    if (atrasado) {
      sumPending += totalComMulta;
      countPending++;
    }

    let daysLeftText, daysLeftClass;
    if (diff > 5) {
      daysLeftText = `Faltam ${diff} dias`;
      daysLeftClass = 'ok';
    } else if (diff >= 0) {
      daysLeftText = `Faltam ${diff} dias (aten√ß√£o)`;
      daysLeftClass = 'warn';
    } else {
      daysLeftText = `Atrasado h√° ${Math.abs(diff)} dias`;
      daysLeftClass = 'late';
    }

    const card = document.createElement('div');
    card.className = 'loan-card';
    card.innerHTML = `
      <div class="loan-row"><strong>Nome:</strong><div>${loan.personName}</div></div>
      <div class="loan-row"><strong>Data:</strong><div>${new Date(loan.loanDate).toLocaleDateString()}</div></div>
      <div class="loan-row"><strong>Valor:</strong><div>${money(principal)}</div></div>
      <div class="loan-row"><strong>Juros:</strong><div>${rate}%</div></div>
      <div class="loan-row"><strong>Total Previsto:</strong><div>${money(totalPrev)}</div></div>
      <div class="days-left ${daysLeftClass}">${daysLeftText}</div>
      <div class="loan-row"><strong>Status:</strong>
        <div class="status ${atrasado ? 'late' : 'ok'}">${atrasado ? `Atrasado (${Math.abs(diff)}d)` : 'Em dia'}</div>
      </div>
      <div class="actions">
        <button class="edit" onclick="editLoan(${i})">Editar</button>
        <button class="delete" onclick="deleteLoan(${i})">Excluir</button>
        <button class="adjust" onclick="openAdjustModal(${i})">üí∞ Ajustar Valor</button>
      </div>`;
    list.appendChild(card);
  });
  $('#sumPrincipal').textContent = money(sumPrincipal);
  $('#sumWithInterest').textContent = money(sumWithInterest);
  $('#sumPending').textContent = money(sumPending);
  $('#countPending').textContent = countPending;
}

function editLoan(i) {
  const loans = loadLoans();
  const l = loans[i];
  $('#personName').value = l.personName;
  $('#loanAmount').value = l.loanAmount;
  $('#daysToPay').value = l.daysToPay;
  $('#interestRate').value = l.interestRate;
  $('#loanDate').value = l.loanDate;
  $('#editIndex').value = i;
  $('#submitBtn').textContent = 'Salvar';
}

function deleteLoan(i) {
  if (!confirm('Excluir este empr√©stimo?')) return;
  const loans = loadLoans();
  loans.splice(i, 1);
  saveLoans(loans);
  renderLoans($('#searchInput').value);
}

// === Modal Ajuste ===
const adjustModal = document.getElementById('adjustModal');
const adjustPerson = document.getElementById('adjustPerson');
const adjustInput = document.getElementById('adjustInput');
const adjustError = document.getElementById('adjustError');
const cancelAdjust = document.getElementById('cancelAdjust');
const confirmAdjust = document.getElementById('confirmAdjust');

let currentAdjustIndex = null;

function openAdjustModal(i) {
  const loans = loadLoans();
  const loan = loans[i];
  currentAdjustIndex = i;
  adjustPerson.textContent = `Pessoa: ${loan.personName}`;
  adjustInput.value = '';
  adjustError.textContent = '';
  adjustModal.style.display = 'flex';
  adjustInput.focus();
}

function closeAdjustModal() {
  adjustModal.style.display = 'none';
  currentAdjustIndex = null;
}

cancelAdjust.onclick = () => closeAdjustModal();

confirmAdjust.onclick = () => {
  const ajusteStr = adjustInput.value.trim();
  if (ajusteStr === '') {
    adjustError.textContent = 'Por favor, digite um valor de ajuste.';
    return;
  }
  const ajuste = parseFloat(ajusteStr);
  if (isNaN(ajuste) || ajuste === 0) {
    adjustError.textContent = 'Valor inv√°lido. Digite um n√∫mero diferente de zero.';
    return;
  }

  const loans = loadLoans();
  const loan = loans[currentAdjustIndex];
  const novoValor = parseNum(loan.loanAmount) + ajuste;
  if (novoValor < 0) {
    adjustError.textContent = 'O valor final n√£o pode ser negativo.';
    return;
  }

  loan.loanAmount = novoValor.toFixed(2);

  loans[currentAdjustIndex] = loan;
  saveLoans(loans);

  alert(
    `Empr√©stimo ajustado!\nNovo valor: ${money(novoValor)}`
  );
  closeAdjustModal();
  renderLoans($('#searchInput').value);
};

// Fechar modal ao clicar fora do conte√∫do
window.onclick = function(event) {
  if (event.target === adjustModal) {
    closeAdjustModal();
  }
};

$('#loanForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const loans = loadLoans();
  const newLoan = {
    personName: $('#personName').value,
    loanAmount: $('#loanAmount').value,
    daysToPay: $('#daysToPay').value,
    interestRate: $('#interestRate').value,
    loanDate: $('#loanDate').value,
  };
  const idx = $('#editIndex').value;
  if (idx) {
    loans[idx] = newLoan;
    $('#submitBtn').textContent = 'Adicionar';
    $('#editIndex').value = '';
  } else loans.push(newLoan);
  saveLoans(loans);
  e.target.reset();
  renderLoans($('#searchInput').value);
});

$('#searchInput').addEventListener('input', (e) => renderLoans(e.target.value));
document.addEventListener('DOMContentLoaded', () => renderLoans());

// === EXPORTA√á√ÉO ===
function exportExcel() {
  const loans = loadLoans();
  if (loans.length === 0) return alert('Nenhum empr√©stimo para exportar.');
  const data = loans.map((l) => {
    const juros = parseNum(l.loanAmount) * (parseNum(l.interestRate) / 100) * parseNum(l.daysToPay);
    return {
      Nome: l.personName,
      Data: new Date(l.loanDate).toLocaleDateString(),
      Valor: l.loanAmount,
      Dias: l.daysToPay,
      Juros: l.interestRate + '%',
      Total: (parseNum(l.loanAmount) + juros).toFixed(2),
    };
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, 'Empr√©stimos');
  XLSX.writeFile(wb, 'emprestimos.xlsx');
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text('Relat√≥rio de Empr√©stimos', 14, 15);
  const loans = loadLoans();
  const rows = loans.map((l) => {
    const juros = parseNum(l.loanAmount) * (parseNum(l.interestRate) / 100) * parseNum(l.daysToPay);
    return [
      l.personName,
      new Date(l.loanDate).toLocaleDateString(),
      'R$ ' + parseNum(l.loanAmount).toFixed(2),
      l.daysToPay,
      l.interestRate + '%',
      'R$ ' + (parseNum(l.loanAmount) + juros).toFixed(2),
    ];
  });
  doc.autoTable({
    startY: 25,
    head: [['Nome', 'Data', 'Valor', 'Dias', 'Juros', 'Total']],
    body: rows,
  });
  doc.save('emprestimos.pdf');
}
</script>
</body>
</html>
