<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Controle de EmprÃ©stimos</title>

<style>
:root {
  --bg: #0a0f1f;
  --card: #141c2f;
  --text: #e2e8f0;
  --muted: #94a3b8;
  --accent: #27cbe0;
  --success: #17db9a;
  --danger: #ef4444;
  --border: rgba(255, 255, 255, 0.432);
  --radius: 12px;
}

.light-mode {
  --bg: #f5f7fa;
  --card: #ffffff;
  --text: #1f2937;
  --muted: #6b7280;
  --accent: #3b82f6;
  --success: #16a34a;
  --danger: #dc2626;
  --border: rgba(0, 0, 0, 0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Inter", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 16px;
}
.container{
  max-width: 800px;
  margin: auto;
}
h1 {
  text-align: center;
  font-size: 2rem;
  margin-bottom: 12px;
}
.top-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}
.summary-card {
  flex: 1 1 160px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 12px;
  text-align: center;
}
.summary-card .label { color: var(--muted); font-size: 0.8rem; }
.summary-card .value { font-size: 1.1rem; font-weight: bold; margin-top: 4px; color: var(--accent); }

.form-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 18px;
}
form {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
form input {
  flex: 1 1 180px;
  padding: 8px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text);
}
button.add {
  padding: 10px 14px;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  font-weight: bold;
  background: var(--accent);
  color: white;
  flex: 1 1 100px;
}
.search-box {
  margin-bottom: 14px;
  display: flex;
  justify-content: center;
}
.search-box input {
  width: 100%;
  max-width: 500px;
  padding: 10px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text);
  text-align: center;
}
.loan-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.loan-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
}
.loan-row {
  display: flex;
  justify-content: space-between;
  margin: 4px 0;
  font-size: 0.9rem;
}
.loan-row strong { color: var(--muted); }
.actions {
  display: flex;
  justify-content: end;
  gap: 6px;
  margin-top: 8px;
}
.status {
  padding: 4px 8px;
  border-radius: 8px;
  font-weight: 600;
}
.status.ok { background: rgba(16,185,129,0.1); color: var(--success); }
.status.late { background: rgba(239,68,68,0.1); color: var(--danger); }
.days-left {
  font-weight: bold;
  margin-top: 6px;
}
.days-left.ok { color: var(--success); }
.days-left.warn { color: #facc15; }
.days-left.late { color: var(--danger); }

button.edit {
  background: var(--success);
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 6px 10px;
  cursor: pointer;
}
button.delete {
  background: var(--danger);
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 6px 10px;
  cursor: pointer;
}
button.adjust {
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 6px 10px;
  cursor: pointer;
}

.whatsapp-link {
  background-color: #25d366;
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  display: inline-block;
  margin-top: 10px;
  cursor: pointer;
}
.whatsapp-link:hover {
  background-color: #1ebe57;
}

@media (max-width: 600px) {
  .loan-row { flex-direction: column; align-items: flex-start; }
  form input, button.add { flex: 1 1 100%; }
}

.top-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

#btnDashboard {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 10px 18px;
  cursor: pointer;
  font-size: 0.95em;
  transition: 0.3s ease;
}

#btnDashboard:hover {
  background: var(--success);
  transform: scale(1.05);
}


</style>
</head>
<body>
<div class="container">

<h1>ðŸ“˜ Controle de EmprÃ©stimos</h1>
<div class="top-buttons">
  <button id="btnDashboard" onclick="window.location.href='dashboard.html'">ðŸ“Š Dashboard</button>
</div>

<div style="text-align: center; margin-bottom: 20px;">
  <button id="toggleThemeBtn" style="
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 12px;
    cursor: pointer;
  ">Modo Claro</button>
</div>

<div class="top-summary">
  <div class="summary-card">
    <div class="label">Total Emprestado</div>
    <div class="value" id="sumPrincipal">R$ 0,00</div>
  </div>
  <div class="summary-card">
    <div class="label">Total com Juros</div>
    <div class="value" id="sumWithInterest">R$ 0,00</div>
  </div>
  <div class="summary-card">
    <div class="label">Total Pendente</div>
    <div class="value" id="sumPending">R$ 0,00</div>
  </div>
  <div class="summary-card">
    <div class="label">Pendentes</div>
    <div class="value" id="countPending">0</div>
  </div>
</div>

<div class="form-card">
  <form id="loanForm" enctype="multipart/form-data">
  <input type="hidden" id="editIndex" />
  <input type="text" id="personName" placeholder="Nome da pessoa" required />
  <input type="number" id="loanAmount" placeholder="Valor (R$)" step="0.01" required />
  <input type="number" id="daysToPay" placeholder="Dias para pagar" required />
  <input type="number" id="interestRate" placeholder="Juros diÃ¡rio (%)" step="0.01" required />
  <input type="date" id="loanDate" required />
  <input type="tel" id="phoneNumber" placeholder="Telefone (ex: 5511999999999)" pattern="[0-9]{10,15}" />

  <!-- Uploads -->
  <label style="width:100%; display:block; margin-top:6px; font-size:0.85rem; color:var(--muted)">Foto de Perfil (jpg/png) â€” max 2MB</label>
  <input type="file" id="profilePhoto" accept="image/*" />

  <label style="width:100%; display:block; margin-top:6px; font-size:0.85rem; color:var(--muted)">Foto do CPF (jpg/png) â€” max 2MB</label>
  <input type="file" id="cpfPhoto" accept="image/*" />

  <label style="width:100%; display:block; margin-top:6px; font-size:0.85rem; color:var(--muted)">Comprovante de ResidÃªncia (jpg/png/pdf) â€” max 2MB</label>
  <input type="file" id="proofPhoto" accept="image/*,application/pdf" />

  <div style="display:flex; gap:10px; align-items:center; width:100%;">
    <button class="add" type="submit" id="submitBtn">Adicionar</button>
    <div id="previewUploads" style="display:flex; gap:8px; align-items:center;"></div>
  </div>
</form>

</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="ðŸ” Buscar por nome..." />
</div>

<div class="loan-list" id="loanList"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
  const $ = (s) => document.querySelector(s);
  function money(v) {
    return 'R$ ' + Number(v).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
  }
  function parseNum(v) {
    return parseFloat(v) || 0;
  }
  function loadLoans() {
    return JSON.parse(localStorage.getItem('loansData') || '[]');
  }
  function saveLoans(d) {
    localStorage.setItem('loansData', JSON.stringify(d));
  }

  function renderLoans(filter = '') {
    const list = document.getElementById('loanList');
    const data = loadLoans().filter((l) => l.personName.toLowerCase().includes(filter.toLowerCase()));
    list.innerHTML = '';
    let sumPrincipal = 0,
      sumWithInterest = 0,
      sumPending = 0,
      countPending = 0;
    const now = new Date();

    data.forEach((loan, i) => {
      const principal = parseNum(loan.loanAmount);
      const days = Number(loan.daysToPay);
      const rate = parseNum(loan.interestRate);
      const juros = principal * (rate / 100) * days;
      const totalPrev = principal + juros;
      const due = new Date(loan.loanDate);
      due.setDate(due.getDate() + days);
      const diff = Math.floor((due - now) / (1000 * 60 * 60 * 24));
      const atrasado = diff < 0;
      const multa = atrasado ? totalPrev * 0.02 * -diff : 0;
      const totalComMulta = totalPrev + multa;

      sumPrincipal += principal;
      sumWithInterest += totalPrev;
      if (atrasado) {
        sumPending += totalComMulta;
        countPending++;
      }

      let daysLeftText, daysLeftClass;
      if (diff > 5) {
        daysLeftText = `Faltam ${diff} dias`;
        daysLeftClass = 'ok';
      } else if (diff >= 0) {
        daysLeftText = `Faltam ${diff} dias (atenÃ§Ã£o)`;
        daysLeftClass = 'warn';
      } else {
        daysLeftText = `Atrasado hÃ¡ ${Math.abs(diff)} dias`;
        daysLeftClass = 'late';
      }

      let mensagemWhatsApp =
        `OlÃ¡ ${loan.personName},\n` +
        `Seu emprÃ©stimo de R$ ${principal.toFixed(2)} feito em ${new Date(loan.loanDate).toLocaleDateString()} ` +
        `vence em ${days} dias com juros diÃ¡rio de ${rate}%. ` +
        `Total previsto para pagamento: R$ ${totalPrev.toFixed(2)}.`;

      if (atrasado) {
        mensagemWhatsApp += `\n\nATENÃ‡ÃƒO: Seu emprÃ©stimo estÃ¡ atrasado hÃ¡ ${Math.abs(diff)} dias!`;
      } else if (diff === 0) {
        mensagemWhatsApp += `\n\nSeu emprÃ©stimo vence hoje!`;
      }

      const linkWhatsApp = loan.phoneNumber
        ? `https://wa.me/${loan.phoneNumber}?text=${encodeURIComponent(mensagemWhatsApp)}`
        : null;

      const card = document.createElement('div');
      card.className = 'loan-card';
      card.innerHTML = `
        <div class="loan-row"><strong>Nome:</strong><div>${loan.personName}</div></div>
        <div class="loan-row"><strong>Data:</strong><div>${new Date(loan.loanDate).toLocaleDateString()}</div></div>
        <div class="loan-row"><strong>Valor:</strong><div>${money(principal)}</div></div>
        <div class="loan-row"><strong>Juros:</strong><div>${rate}%</div></div>
        <div class="loan-row"><strong>Total Previsto:</strong><div>${money(totalPrev)}</div></div>
        <div class="days-left ${daysLeftClass}">${daysLeftText}</div>
        <div class="loan-row"><strong>Status:</strong>
          <div class="status ${atrasado ? 'late' : 'ok'}">${atrasado ? `Atrasado (${Math.abs(diff)}d)` : 'Em dia'}</div>
        </div>
        <div class="actions">
          <button class="edit" onclick="editLoan(${i})">Editar</button>
          <button class="delete" onclick="deleteLoan(${i})">Excluir</button>
          <button class="adjust" onclick="adjustLoan(${i})">ðŸ’° Ajustar Valor</button>
          ${linkWhatsApp ? `<a href="${linkWhatsApp}" target="_blank" rel="noopener noreferrer" class="whatsapp-link">ðŸ“² Enviar WhatsApp</a>` : ''}
        </div>
      `;
      list.appendChild(card);
    });

    document.getElementById('sumPrincipal').textContent = money(sumPrincipal);
    document.getElementById('sumWithInterest').textContent = money(sumWithInterest);
    document.getElementById('sumPending').textContent = money(sumPending);
    document.getElementById('countPending').textContent = countPending;
  }

   // Leitura de arquivo para dataURL (Promise)
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      if (!file) return resolve(null);
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ValidaÃ§Ã£o simples de arquivo (tipo + tamanho)
  function validateFile(file, allowedTypes = [], maxMB = 2) {
    if (!file) return { ok: true };
    const sizeMB = file.size / (1024 * 1024);
    if (sizeMB > maxMB) return { ok: false, error: `Arquivo muito grande (${sizeMB.toFixed(2)} MB). MÃ¡x ${maxMB}MB.` };
    if (allowedTypes.length) {
      const isOk = allowedTypes.some(t => file.type.includes(t));
      if (!isOk) return { ok: false, error: `Tipo de arquivo invÃ¡lido: ${file.type}` };
    }
    return { ok: true };
  }

  // Atualiza preview dos uploads abaixo do botÃ£o
  function updatePreviewInputs() {
    const previewDiv = document.getElementById('previewUploads');
    previewDiv.innerHTML = '';
    const p = document.getElementById('profilePhoto').files[0];
    const c = document.getElementById('cpfPhoto').files[0];
    const r = document.getElementById('proofPhoto').files[0];

    [ {file:p,label:'Perfil'}, {file:c,label:'CPF'}, {file:r,label:'Comprov.'} ].forEach(item => {
      if (!item.file) return;
      const v = document.createElement('div');
      v.style.textAlign = 'center';
      v.style.fontSize = '0.8rem';
      v.style.maxWidth = '72px';
      v.style.wordBreak = 'break-word';

      if (item.file.type === 'application/pdf') {
        v.innerHTML = `<div style="font-size:24px">ðŸ“„</div><div>${item.label}</div>`;
      } else {
        const img = document.createElement('img');
        img.style.width = '60px';
        img.style.height = '60px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';
        const url = URL.createObjectURL(item.file);
        img.src = url;
        v.appendChild(img);
        const lbl = document.createElement('div');
        lbl.textContent = item.label;
        v.appendChild(lbl);
      }
      previewDiv.appendChild(v);
    });
  }

  // Ouvir mudanÃ§as nos inputs para mostrar preview imediato
  ['profilePhoto','cpfPhoto','proofPhoto'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('change', updatePreviewInputs);
  });

  // Handler do formulÃ¡rio (async porque precisa ler arquivos)
  $('#loanForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const loans = loadLoans();

    // Valida arquivos
    const profileFile = document.getElementById('profilePhoto').files[0];
    const cpfFile = document.getElementById('cpfPhoto').files[0];
    const proofFile = document.getElementById('proofPhoto').files[0];

    const v1 = validateFile(profileFile, ['image']);
    const v2 = validateFile(cpfFile, ['image']);
    const v3 = validateFile(proofFile, ['image','application/pdf']);
    if (!v1.ok) return alert(v1.error);
    if (!v2.ok) return alert(v2.error);
    if (!v3.ok) return alert(v3.error);

    // Ler arquivos como Data URLs
    const [profileData, cpfData, proofData] = await Promise.all([
      readFileAsDataURL(profileFile),
      readFileAsDataURL(cpfFile),
      readFileAsDataURL(proofFile)
    ]);

    const newLoan = {
      personName: $('#personName').value,
      loanAmount: $('#loanAmount').value,
      daysToPay: $('#daysToPay').value,
      interestRate: $('#interestRate').value,
      loanDate: $('#loanDate').value,
      phoneNumber: $('#phoneNumber').value.trim(),
      attachments: {
        profilePhoto: profileData || null,
        cpfPhoto: cpfData || null,
        proofPhoto: proofData || null
      }
    };

    const idx = $('#editIndex').value;
    if (idx) {
      loans[idx] = newLoan;
      $('#submitBtn').textContent = 'Adicionar';
      $('#editIndex').value = '';
    } else {
      loans.push(newLoan);
    }

    saveLoans(loans);
    e.target.reset();
    updatePreviewInputs();
    renderLoans($('#searchInput').value);
  });

  // Editar emprÃ©stimo: preenche formulÃ¡rio e previews com attachments
  function editLoan(i) {
    const loans = loadLoans();
    const l = loans[i];
    $('#personName').value = l.personName;
    $('#loanAmount').value = l.loanAmount;
    $('#daysToPay').value = l.daysToPay;
    $('#interestRate').value = l.interestRate;
    $('#loanDate').value = l.loanDate;
    $('#phoneNumber').value = l.phoneNumber || '';
    $('#editIndex').value = i;
    $('#submitBtn').textContent = 'Salvar';

    // Remover valores de file inputs (nÃ£o podemos povoar file inputs por seguranÃ§a),
    // entÃ£o mostramos previews usando os DataURLs salvos.
    const previewDiv = document.getElementById('previewUploads');
    previewDiv.innerHTML = '';
    if (l.attachments) {
      const buildPreview = (dataUrl, label) => {
        if (!dataUrl) return;
        const v = document.createElement('div');
        v.style.textAlign = 'center';
        v.style.fontSize = '0.8rem';
        v.style.maxWidth = '72px';
        if (dataUrl.startsWith('data:application/pdf')) {
          v.innerHTML = `<div style="font-size:24px">ðŸ“„</div><div>${label}</div>`;
        } else {
          const img = document.createElement('img');
          img.style.width = '60px';
          img.style.height = '60px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.src = dataUrl;
          v.appendChild(img);
          const lbl = document.createElement('div');
          lbl.textContent = label;
          v.appendChild(lbl);
        }
        previewDiv.appendChild(v);
      };
      buildPreview(l.attachments.profilePhoto, 'Perfil');
      buildPreview(l.attachments.cpfPhoto, 'CPF');
      buildPreview(l.attachments.proofPhoto, 'Comprov.');
    }
  }

  // Atualizar renderLoans para exibir miniaturas / links dos attachments
  const originalRender = renderLoans;
  renderLoans = function(filter = '') {
    // chamamos a funÃ§Ã£o original para manter cÃ¡lculos e criaÃ§Ã£o base dos cards
    originalRender(filter);

    // agora adicionamos previews/links nas loan-cards
    const list = document.getElementById('loanList');
    const cards = list.querySelectorAll('.loan-card');
    const loans = loadLoans().filter((l) => l.personName.toLowerCase().includes(filter.toLowerCase()));

    cards.forEach((card, i) => {
      const l = loans[i];
      if (!l) return;
      // criar container de attachments
      let attachDiv = card.querySelector('.attachments');
      if (!attachDiv) {
        attachDiv = document.createElement('div');
        attachDiv.className = 'attachments';
        attachDiv.style.marginTop = '8px';
        attachDiv.style.display = 'flex';
        attachDiv.style.gap = '8px';
        card.appendChild(attachDiv);
      } else {
        attachDiv.innerHTML = '';
      }

      const makeThumb = (dataUrl, title) => {
        if (!dataUrl) return;
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.flexDirection = 'column';
        wrapper.style.alignItems = 'center';
        wrapper.style.fontSize = '0.75rem';
        wrapper.style.textAlign = 'center';

        if (dataUrl.startsWith('data:application/pdf')) {
          const a = document.createElement('a');
          a.href = dataUrl;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.style.textDecoration = 'none';
          a.innerHTML = `<div style="font-size:20px">ðŸ“„</div><div style="max-width:70px;">${title}</div>`;
          wrapper.appendChild(a);
        } else {
          const img = document.createElement('img');
          img.src = dataUrl;
          img.style.width = '54px';
          img.style.height = '54px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.style.cursor = 'pointer';
          img.title = 'Abrir em tamanho real';
          img.onclick = () => {
            const w = window.open('');
            w.document.write(`<img src="${dataUrl}" style="max-width:100%;">`);
          };
          wrapper.appendChild(img);
          const lbl = document.createElement('div');
          lbl.textContent = title;
          wrapper.appendChild(lbl);
        }

        // BotÃ£o pequeno para baixar
        const down = document.createElement('a');
        down.href = dataUrl;
        down.download = `${l.personName}_${title}`;
        down.style.fontSize = '0.7rem';
        down.style.marginTop = '4px';
        down.textContent = 'Baixar';
        wrapper.appendChild(down);

        attachDiv.appendChild(wrapper);
      };

      if (l.attachments) {
        makeThumb(l.attachments.profilePhoto, 'Perfil');
        makeThumb(l.attachments.cpfPhoto, 'CPF');
        makeThumb(l.attachments.proofPhoto, 'Comprov.');
      }
    });
  };

  // Inicializa previews caso jÃ¡ exista arquivo selecionado no form
  updatePreviewInputs();


  function deleteLoan(i) {
    if (!confirm('Excluir este emprÃ©stimo?')) return;
    const loans = loadLoans();
    loans.splice(i, 1);
    saveLoans(loans);
    renderLoans($('#searchInput').value);
  }

  function adjustLoan(i) {
    const loans = loadLoans();
    const l = loans[i];

    const ajusteStr = prompt(
      `Digite o valor do ajuste para ${l.personName}:\n(use nÃºmero positivo para acrescentar ou negativo para subtrair)`
    );

    if (ajusteStr === null) return;
    const ajuste = parseFloat(ajusteStr);
    if (isNaN(ajuste) || ajuste === 0) return alert('Valor invÃ¡lido.');

    const novoValor = parseNum(l.loanAmount) + ajuste;
    if (novoValor < 0) return alert('O valor final nÃ£o pode ser negativo.');

    l.loanAmount = novoValor.toFixed(2);
    loans[i] = l;
    saveLoans(loans);
    alert(`EmprÃ©stimo ajustado!\nNovo valor: ${money(novoValor)}`);
    renderLoans($('#searchInput').value);
  }

  $('#loanForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const loans = loadLoans();
    const newLoan = {
      personName: $('#personName').value,
      loanAmount: $('#loanAmount').value,
      daysToPay: $('#daysToPay').value,
      interestRate: $('#interestRate').value,
      loanDate: $('#loanDate').value,
      phoneNumber: $('#phoneNumber').value.trim(),
    };
    const idx = $('#editIndex').value;
    if (idx) {
      loans[idx] = newLoan;
      $('#submitBtn').textContent = 'Adicionar';
      $('#editIndex').value = '';
    } else {
      loans.push(newLoan);
    }
    saveLoans(loans);
    e.target.reset();
    renderLoans($('#searchInput').value);
  });

  $('#searchInput').addEventListener('input', (e) => renderLoans(e.target.value));
  document.addEventListener('DOMContentLoaded', () => renderLoans());

  // --- Tema claro/escuro ---
  const toggleBtn = document.getElementById('toggleThemeBtn');
  const body = document.body;

  function setTheme(isLight) {
    if (isLight) {
      body.classList.add('light-mode');
      toggleBtn.textContent = 'Modo Escuro';
      localStorage.setItem('theme', 'light');
    } else {
      body.classList.remove('light-mode');
      toggleBtn.textContent = 'Modo Claro';
      localStorage.setItem('theme', 'dark');
    }
  }

  // Verificar preferÃªncia salva
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') {
    setTheme(true);
  } else {
    setTheme(false);
  }

  toggleBtn.addEventListener('click', () => {
    const isLight = body.classList.contains('light-mode');
    setTheme(!isLight);
  });





  // --- BotÃµes de exportaÃ§Ã£o ---
  const exportContainer = document.createElement('div');
  exportContainer.style.textAlign = 'center';
  exportContainer.style.marginBottom = '20px';
  exportContainer.innerHTML = `
    <button id="exportExcelBtn" style="
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      margin-right: 8px;
    ">ðŸ“Š Exportar Excel</button>
    <button id="exportPDFBtn" style="
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
    ">ðŸ“„ Exportar PDF</button>
  `;
  document.querySelector('.container').insertBefore(exportContainer, document.querySelector('.top-summary'));

  // --- FunÃ§Ã£o para exportar para Excel ---
  function exportToExcel() {
    const data = loadLoans();
    if (data.length === 0) {
      alert("Nenhum dado para exportar.");
      return;
    }

    const rows = data.map(l => {
      const principal = parseNum(l.loanAmount);
      const rate = parseNum(l.interestRate);
      const juros = principal * (rate / 100) * Number(l.daysToPay);
      const totalPrev = principal + juros;
      return {
        Nome: l.personName,
        "Valor Emprestado": principal,
        "Dias para Pagar": l.daysToPay,
        "Juros (%)": l.interestRate,
        "Total Previsto": totalPrev.toFixed(2),
        "Data EmprÃ©stimo": new Date(l.loanDate).toLocaleDateString(),
        "Telefone": l.phoneNumber || "-"
      };
    });

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "EmprÃ©stimos");
    XLSX.writeFile(wb, "emprestimos.xlsx");
  }

  // --- FunÃ§Ã£o para exportar para PDF ---
  async function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const data = loadLoans();

  if (data.length === 0) {
    alert("Nenhum dado para exportar.");
    return;
  }

  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  const pageWidth = doc.internal.pageSize.getWidth();

  // --- CabeÃ§alho ---
  const logoUrl = ""; // ðŸ‘‰ coloque aqui a URL da sua logo (ou deixe vazio)
  if (logoUrl) {
    const img = new Image();
    img.src = logoUrl;
    await new Promise((r) => (img.onload = r));
    doc.addImage(img, "PNG", 10, 8, 20, 20);
  }

  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("RelatÃ³rio de EmprÃ©stimos", pageWidth / 2, 20, { align: "center" });

  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  const dataAtual = new Date().toLocaleDateString("pt-BR");
  doc.text(`Data do relatÃ³rio: ${dataAtual}`, pageWidth - 14, 30, { align: "right" });

  // --- Corpo da tabela ---
  const tableData = data.map((l) => {
    const principal = parseNum(l.loanAmount);
    const rate = parseNum(l.interestRate);
    const juros = principal * (rate / 100) * Number(l.daysToPay);
    const totalPrev = principal + juros;
    return [
      l.personName,
      "R$ " + principal.toFixed(2),
      l.daysToPay,
      rate + "%",
      "R$ " + totalPrev.toFixed(2),
      new Date(l.loanDate).toLocaleDateString(),
    ];
  });

  doc.autoTable({
    head: [["Nome", "Valor", "Dias", "Juros", "Total Previsto", "Data"]],
    body: tableData,
    startY: 38,
    styles: { fontSize: 10 },
    headStyles: { fillColor: [39, 203, 224], halign: "center" },
    bodyStyles: { halign: "center" },
  });

  // --- Totais ---
  let sumPrincipal = 0,
    sumWithInterest = 0,
    sumPending = 0,
    countPending = 0;

  const now = new Date();
  data.forEach((loan) => {
    const principal = parseNum(loan.loanAmount);
    const rate = parseNum(loan.interestRate);
    const days = Number(loan.daysToPay);
    const juros = principal * (rate / 100) * days;
    const totalPrev = principal + juros;
    const due = new Date(loan.loanDate);
    due.setDate(due.getDate() + days);
    const diff = Math.floor((due - now) / (1000 * 60 * 60 * 24));
    const atrasado = diff < 0;
    const multa = atrasado ? totalPrev * 0.02 * -diff : 0;
    const totalComMulta = totalPrev + multa;

    sumPrincipal += principal;
    sumWithInterest += totalPrev;
    if (atrasado) {
      sumPending += totalComMulta;
      countPending++;
    }
  });

  const finalY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("Resumo Financeiro", 14, finalY);

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.text(`â€¢ Total Emprestado: R$ ${sumPrincipal.toFixed(2)}`, 14, finalY + 8);
  doc.text(`â€¢ Total com Juros: R$ ${sumWithInterest.toFixed(2)}`, 14, finalY + 14);
  doc.text(`â€¢ Total Pendente: R$ ${sumPending.toFixed(2)}`, 14, finalY + 20);
  doc.text(`â€¢ EmprÃ©stimos Pendentes: ${countPending}`, 14, finalY + 26);

  // --- RodapÃ© ---
  const footerY = 285;
  doc.setFontSize(9);
  doc.setTextColor(120);
  doc.text(
    "Gerado automaticamente pelo Sistema de Controle de EmprÃ©stimos",
    pageWidth / 2,
    footerY,
    { align: "center" }
  );

  // --- Salvar ---
  doc.save(`relatorio_emprestimos_${dataAtual}.pdf`);
}

  // --- Listeners ---
  document.getElementById("exportExcelBtn").addEventListener("click", exportToExcel);
  document.getElementById("exportPDFBtn").addEventListener("click", exportToPDF);


</script>
</div>
</body>
</html>
